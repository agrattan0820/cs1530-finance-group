import React, { useState } from "react";
import { GetServerSideProps, NextPage } from "next";
import Head from "next/head";
import { useRouter } from "next/router";

import { FaHeart, FaLink } from "react-icons/fa";
import { FiRefreshCw, FiShare } from "react-icons/fi";
import { numberWithCommas } from "../../utils/formatters";
import Header from "../../components/header";
import Button from "../../components/button";
import { useGrade, getGrade } from "../../utils/hooks/use-grade";
import { Database } from "../../utils/database.types";
import { useSchool } from "../../utils/hooks/use-school";
import { fetchSchoolById } from "../../utils/queries";

type SchoolInfoProps = {
  name: string;
  city: string;
  state: string;
  net_price: number;
  median_10_salary: number;
  average_loan: number;
};

const SchoolInfo = ({
  name,
  city,
  state,
  net_price,
  median_10_salary,
  average_loan,
}: SchoolInfoProps) => {
  return (
    <section className="mb-8 max-w-xl md:mb-0">
      <div className="mb-2 md:mb-8">
        <h2 className="mb-1 text-4xl font-bold leading-tight md:text-5xl md:leading-tight">
          {name}
        </h2>
        <p>
          {city}, {state}
        </p>
      </div>
      <ul>
        <li className="flex justify-between md:text-lg">
          <p className="font-bold">Average net price per year</p>
          <p>${numberWithCommas(net_price)}</p>
        </li>
        <li className="flex justify-between md:text-lg">
          <p className="font-bold">Average loan amount</p>
          <p>${numberWithCommas(average_loan)}</p>
        </li>
        <li className="flex justify-between md:text-lg">
          <p className="font-bold">Median 10 year salary</p>
          <p>${numberWithCommas(median_10_salary)}</p>
        </li>
      </ul>
    </section>
  );
};

type PageProps = {
  grade: Database["public"]["Tables"]["grade"]["Row"];
  // TODO: Type school response
  school: any;
};

const GradeResultPage: NextPage<PageProps> = (props) => {
  /**
   * Tasks
   * - Save grade to Supabase database
   * - Pull in grade from data, Zustand?
   * - Show info on the school
   * - Show share button
   * - Show save button
   */
  const router = useRouter();
  const [copying, setCopying] = useState(false);
  const [scoreResult, setScoreResult] = useState({
    gradeNumber: 10,
    schoolId: 100654,
    userId: 3,
    financialAidAmount: 12000,
    inOutState: "IN-STATE",
  });
  const { gradeId } = router.query;
  const grade = useGrade(Number.parseInt(gradeId as string), props.grade);
  const schoolId = props.grade.school_id;

  const school = useSchool(schoolId, props.school);

  /**  Function for share button that either copies the link to clipboard or activates the mobile share if available */
  const shareLink = () => {
    console.log("clicked!");
    if (navigator.share) {
      navigator
        .share({
          title: `GradeMyAid Rating`,
          url: typeof window !== "undefined" ? window.location.href : "",
        })
        .then(() => {
          console.log(`Thanks for sharing!`);
        })
        .catch(console.error);
    } else {
      const cb = navigator.clipboard;
      if (copying) {
        setCopying(false);
      }
      cb.writeText(typeof window !== "undefined" ? window.location.href : "")
        .then(() => {
          setCopying(true);
        })
        .catch(console.error);
    }
  };

  const schoolData = !school.isLoading && school.data?.data?.results[0];

  console.log(schoolData);

  return (
    <div>
      <Head>
        <title>GradeMyAid</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header />
      <main className="flex min-h-screen flex-col items-center justify-center space-y-16 bg-emerald-200 px-8 py-28">
        <div className="flex flex-col-reverse items-center justify-center md:flex-row md:space-x-8">
          <section className="flex h-96 min-w-full flex-col items-center justify-center rounded-2xl bg-emerald-50 p-8 shadow-lg shadow-emerald-300 md:min-w-[20rem]">
            <p className="font-bold">Your grade:</p>
            {!grade.isLoading ? (
              <p className="text-9xl font-bold leading-tight xl:text-[12rem]">
                {grade.data?.grade_num}
              </p>
            ) : (
              <p className="text-9xl font-bold leading-none xl:text-[12rem]">
                {" "}
              </p>
            )}
            <p className="-mt-8 font-bold">out of 10</p>
          </section>
          {!school.isLoading && schoolData ? (
            <SchoolInfo
              name={schoolData.school.name}
              city={schoolData.school.city}
              state={schoolData.school.state}
              median_10_salary={
                schoolData.latest.earnings["10_yrs_after_entry"].median
              }
              net_price={schoolData.latest.cost.avg_net_price.overall}
              average_loan={schoolData.latest.aid.loan_principal}
            />
          ) : (
            <div>Loading...</div>
          )}
        </div>
        <div className="flex flex-col items-center justify-center space-y-4">
          <div className="flex space-x-4">
            <Button color="rose" label="Save Grade" icon={<FaHeart />} />
            <div className="relative z-10">
              <Button
                onClick={shareLink}
                color="violet"
                label="Share Grade"
                icon={<FiShare />}
              />
              <div
                // Role alert and aria-live announce to screen readers
                role="alert"
                aria-live="polite"
                className={`share-popup pointer-events-none absolute top-0 left-1/2 z-10 w-56 max-w-3xl origin-center rounded-md bg-violet-300 px-4 py-2 text-center text-sm font-bold ${
                  copying && "animate-popup"
                }`}
              >
                <p className={`${!copying && "hidden"} flex items-center`}>
                  URL Copied to Clipboard <FaLink className="ml-2" />
                </p>
              </div>
            </div>
          </div>
          <Button
            color="emerald"
            label="Do Another Grade"
            icon={<FiRefreshCw />}
            onClick={() => router.push("/homepage")}
          />
        </div>
      </main>
    </div>
  );
};

export default GradeResultPage;

export const getServerSideProps: GetServerSideProps = async (context) => {
  const { gradeId } = context.query;
  const grade = await getGrade(Number.parseInt(gradeId as string));
  const schoolResponse = await fetchSchoolById(grade.school_id);
  const school = schoolResponse.data;
  return { props: { grade, school } };
};
